# UHDadmin Slave - OpenResty Main Configuration
# This file is the base template; slave_config values from UHDadmin override placeholders.

worker_processes auto;
error_log /var/log/openresty/error.log warn;
pid /run/openresty.pid;

# Allow env variables to be accessed from Lua via os.getenv()
env UHDADMIN_URL;
env APP_TOKEN;
env REDIS_HOST;
env REDIS_PORT;
env REDIS_DB;
env REDIS_PASSWORD;
env CONFIG_PULL_INTERVAL;
env TELEMETRY_FLUSH_INTERVAL;
env QUOTA_SYNC_INTERVAL;
env HEARTBEAT_INTERVAL;
env EMBY_API_KEY;
env EMBY_SERVER_URL;
env TOKEN_RESOLVE_INTERVAL;
env SESSION_HEARTBEAT_INTERVAL;

events {
    worker_connections 4096;
    multi_accept on;
}

http {
    include       /usr/local/openresty/nginx/conf/mime.types;
    default_type  application/octet-stream;

    # Logging
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'rt=$request_time';

    access_log /var/log/openresty/access.log main;

    # Performance
    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;

    # Buffers
    client_max_body_size 100m;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Gzip (controlled by config)
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml;
    gzip_min_length 1000;

    # Shared dictionaries for Lua
    # L1: volatile rate limit counters (req/s, req/min) - OK to lose on restart
    lua_shared_dict rate_limit 32m;
    # Config cache (repopulated from UHDadmin on restart)
    lua_shared_dict config_cache 10m;
    # Telemetry batching buffer (short-lived, OK to lose some entries)
    lua_shared_dict telemetry_buffer 32m;
    # Realtime session tracking
    lua_shared_dict session_store 16m;

    # Lua package path
    lua_package_path '/opt/slave/lua/?.lua;/opt/slave/lua/lib/?.lua;/opt/slave/lua/filters/?.lua;;';
    lua_package_cpath '/usr/local/openresty/lualib/?.so;;';

    # Init worker - start background timers
    init_worker_by_lua_file /opt/slave/lua/init_worker.lua;

    # Include generated server blocks
    include /opt/slave/conf/upstream.conf;
    include /opt/slave/conf/maps.conf;
    include /opt/slave/conf/server.conf;
}
